<!DOCTYPE html>
<html>
<head>
    <title>小依自定义API配置</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .api-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .param-card {
            border: 1px solid #eee;
            padding: 10px;
            margin: 5px 0;
            background-color: #fff;
            border-radius: 3px;
        }
        .button {
            background-color: #fab3f4;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .delete-button {
            background-color: #f44336;
        }
        .button:hover {
            opacity: 0.8;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 100px;
            margin-right: 10px;
        }
        .input-group input, .input-group select {
            width: 300px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .custom-response {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        .variable-help {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .variable-help ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .variable-help li {
            margin: 3px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>小依自定义API配置</h1>
    <div id="apis"></div>
    <div style="margin-top: 20px;">
        <button class="button" onclick="addAPI()">添加新API</button>
        <button class="button" onclick="saveAll()">保存配置</button>
    </div>

    <script>
        let apis = [];
        try {
            apis = JSON.parse('{{ apis|tojson|safe }}');
        } catch (e) {
            console.error('加载API配置失败:', e);
            apis = [];
        }

        function renderAPIs() {
            const container = document.getElementById('apis');
            container.innerHTML = '';
            
            apis.forEach((api, index) => {
                const apiDiv = document.createElement('div');
                apiDiv.className = 'api-card';
                apiDiv.innerHTML = `
                    <h3>API ${index + 1}</h3>
                    <div class="input-group">
                        <label>触发命令：</label>
                        <input type="text" value="${api.command || ''}" 
                               onchange="updateAPI(${index}, 'command', this.value)"
                               placeholder="例如：天气">
                    </div>
                    <div class="input-group">
                        <label>API URL：</label>
                        <input type="text" value="${api.url || ''}" 
                               onchange="updateAPI(${index}, 'url', this.value)"
                               placeholder="例如：https://api.example.com/weather">
                    </div>
                    <div class="input-group">
                        <label>返回类型：</label>
                        <select onchange="updateAPI(${index}, 'response_type', this.value)">
                            <option value="text" ${(api.response_type === 'text') ? 'selected' : ''}>文本</option>
                            <option value="image" ${(api.response_type === 'image') ? 'selected' : ''}>图片</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>响应路径：</label>
                        <input type="text" value="${api.response_path || ''}" 
                               onchange="updateAPI(${index}, 'response_path', this.value)"
                               placeholder="例如：data.weather.text">
                    </div>
                    <div class="input-group">
                        <label>自定义回复：</label>
                        <textarea class="custom-response" 
                                  onchange="updateAPI(${index}, 'custom_response', this.value)" 
                                  placeholder="例如：天气预报：【json#weather.text】&#10;温度：【json#weather.temp】℃&#10;发送者：@【发送者QQ】&#10;原始消息：【用户消息】"
                                  rows="4">${api.custom_response || ''}</textarea>
                    </div>
                    <div class="variable-help">
                        <p><strong>可用变量说明：</strong></p>
                        <ul>
                            <li>【json#路径】- 获取JSON响应中的指定字段，例如：【json#data.weather】</li>
                            <li>【用户消息】- 用户发送的原始消息（去除指令部分）</li>
                            <li>【发送者QQ】- 发送消息的用户QQ号</li>
                            <li>【发送者昵称】- 发送消息的用户昵称</li>
                            <li>【当前时间】- 当前时间，格式：YYYY-MM-DD HH:mm:ss</li>
                            <li>【换行】- 插入换行符</li>
                            <li>【图片链接】- API返回的图片URL</li>
                            <li>【at】- @发送者</li>
                            <li>【参数#名称】- 获取指定参数的值</li>
                        </ul>
                    </div>
                    <div class="params-section">
                        <h4>参数配置</h4>
                        <div id="params-${index}"></div>
                        <button class="button" onclick="addParam(${index})">添加参数</button>
                    </div>
                    <button class="button delete-button" onclick="deleteAPI(${index})">删除此API</button>
                `;
                container.appendChild(apiDiv);
                renderParams(index);
            });
        }

        function renderParams(apiIndex) {
            const container = document.getElementById(`params-${apiIndex}`);
            const api = apis[apiIndex];
            if (!api.params) api.params = [];
            
            container.innerHTML = api.params.map((param, paramIndex) => `
                <div class="param-card">
                    <div class="input-group">
                        <label>参数名：</label>
                        <input type="text" value="${param.name || ''}" 
                               onchange="updateParam(${apiIndex}, ${paramIndex}, 'name', this.value)"
                               placeholder="例如：city">
                    </div>
                    <div class="input-group">
                        <label>参数类型：</label>
                        <select onchange="updateParam(${apiIndex}, ${paramIndex}, 'type', this.value)">
                            <option value="user_input" ${param.type === 'user_input' ? 'selected' : ''}>用户输入</option>
                            <option value="text" ${param.type === 'text' ? 'selected' : ''}>固定文本</option>
                            <option value="sender_id" ${param.type === 'sender_id' ? 'selected' : ''}>发送者ID</option>
                        </select>
                    </div>
                    <div class="input-group" ${param.type !== 'text' ? 'style="display:none"' : ''}>
                        <label>参数值：</label>
                        <input type="text" value="${param.value || ''}" 
                               onchange="updateParam(${apiIndex}, ${paramIndex}, 'value', this.value)"
                               placeholder="固定文本值">
                    </div>
                    <button class="button delete-button" onclick="deleteParam(${apiIndex}, ${paramIndex})">删除参数</button>
                </div>
            `).join('');
        }

        function addAPI() {
            apis.push({
                command: '',
                url: '',
                response_type: 'text',
                response_path: '',
                params: []
            });
            renderAPIs();
        }

        function deleteAPI(index) {
            if (confirm('确定要删除这个API配置吗？')) {
                apis.splice(index, 1);
                renderAPIs();
            }
        }

        function addParam(apiIndex) {
            if (!apis[apiIndex].params) apis[apiIndex].params = [];
            apis[apiIndex].params.push({
                name: '',
                type: 'user_input',
                value: ''
            });
            renderParams(apiIndex);
        }

        function deleteParam(apiIndex, paramIndex) {
            if (confirm('确定要删除这个参数吗？')) {
                apis[apiIndex].params.splice(paramIndex, 1);
                renderParams(apiIndex);
            }
        }

        function updateAPI(index, field, value) {
            if (index >= 0 && index < apis.length) {
                apis[index][field] = value;
                console.log(`更新 API ${index} 的 ${field} 为: ${value}`);
            }
        }

        function updateParam(apiIndex, paramIndex, field, value) {
            apis[apiIndex].params[paramIndex][field] = value;
            if (field === 'type') {
                renderParams(apiIndex);
            }
        }

        function saveAll() {
            // 验证数据
            const invalidApis = apis.filter(api => !api.command || !api.url);
            if (invalidApis.length > 0) {
                alert('请填写所有API的命令和URL！');
                return;
            }

            fetch('/api/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(apis)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正确');
                }
                return response.json();
            })
            .then(data => {
                if(data.status === 'success') {
                    alert('保存成功！');
                } else {
                    alert('保存失败：' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('保存失败：' + error.message);
                console.error('保存错误:', error);
            });
        }

        // 页面加载完成后渲染
        document.addEventListener('DOMContentLoaded', function() {
            renderAPIs();
        });
    </script>
</body>
</html>